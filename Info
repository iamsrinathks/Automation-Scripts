

### **Proxy-Only Subnet Management and Scaling for ALB in Cloud Workstations**

In the context of managing **4000 workstations** with a **custom domain and Application Load Balancer (ALB)**, proper planning for **proxy-only subnets** is crucial to handle traffic growth and scaling. Proxy-only subnets cannot be expanded using the traditional method (such as `expand-ip-range`); instead, backup subnets need to be employed. Below is the updated section of the **capacity planning document** to include proxy-only subnet management, based on Google's recommendations.

---

#### **2. Managing and Scaling Proxy-Only Subnets for ALB**

When deploying Application Load Balancer (ALB) for GCP Cloud Workstations, the **proxy-only subnet** must be managed carefully as traffic increases. As outlined, Google Cloud does not allow expanding proxy-only subnets directly, but you can switch between **active** and **backup** subnets.

##### **2.1 Initial Proxy-Only Subnet Allocation**

- **Start with a /23 subnet** (512 IP addresses) to ensure enough capacity for the proxy instances required for 4000 workstations.
- This initial size should be sufficient for **typical workloads** at the beginning. However, you need to monitor usage carefully as traffic may increase over time.

##### **2.2 Scaling the Proxy-Only Subnet**

When traffic increases, you may need to allocate more IP addresses for Envoy proxies by switching to a larger subnet. Google Cloud’s methodology for scaling proxy-only subnets includes the use of **backup subnets**.

- **Create a Backup Proxy-Only Subnet**: If the traffic begins to outgrow the initial /23 subnet, create a new, larger proxy-only subnet as a **backup** (e.g., /22 or /21).
- **Promote the Backup Subnet to Active**:
  - Once the new, larger subnet is created, promote it from **backup** to **active**.
  - The **active** proxy-only subnet handles **new connections** while the **previous active subnet** will be drained of ongoing connections.
  - Google Cloud automatically handles this **seamless transition**, meaning there is no interruption to ongoing or new user connections during the switch.

##### **2.3 Proxy-Only Subnet Considerations**

- **Non-disruptive Transition**: The transition from one proxy-only subnet to another (active to backup) is non-disruptive, which ensures there is no interruption in service during the scaling process.
- **One Active and One Backup Subnet per Region**: Only one active and one backup proxy-only subnet are allowed per region per VPC network.
- **Monitor Traffic**: Continuous monitoring of the traffic patterns and proxy utilization is important to determine when it is time to create a new, larger backup subnet.

##### **2.4 Proxy-Only Subnet Costs**

Each additional proxy instance incurs an **hourly charge**, so it's important to allocate the subnet appropriately to handle traffic demands without over-provisioning. Proxies automatically scale, but ensure to use a reasonable subnet size to manage costs effectively.

---

### **Proxy-Only Subnet Example:**

For a setup with **4000 workstations** using ALB, start with the following structure:

- **Initial Proxy-Only Subnet**: /23 (512 IP addresses)
- **Backup Proxy-Only Subnet (when needed)**: Create a larger /22 (1024 IP addresses) to handle future traffic.
  
This ensures that you have enough capacity for growing traffic without service disruption, while maintaining efficient resource allocation and managing costs.

---

### **Key Actions for Proxy-Only Subnet Management**:

- **Initial Sizing**: Begin with a /23 subnet for 512 IP addresses.
- **Monitoring**: Continuously monitor traffic patterns.
- **Scaling**: When traffic increases, create a larger backup subnet and promote it to active when needed.
- **Seamless Transition**: New connections move to the newly activated subnet, and old connections are drained from the previous one without disruption.

This planning ensures that your **Application Load Balancer (ALB)** can handle the traffic generated by **4000 Cloud Workstations**, with flexibility to scale as needed.




You're right, **Google Cloud doesn't automatically warn you** if the proxy-only subnet is running out of IP addresses, but you can configure **Google Cloud Monitoring** to track the IP address usage and set up alerts. This is critical for ensuring that you don't run out of addresses, especially with the scale of **4000 workstations** and a custom domain setup that uses **Application Load Balancer (ALB)**.

### **Monitoring IP Address Usage for Proxy-Only Subnets**

#### **1. Set Up Monitoring for Proxy-Only Subnet IP Usage**

To avoid running out of IP addresses in your proxy-only subnet, you need to monitor the `loadbalancing.googleapis.com/subnet/proxy_only/addresses` metric, which tracks the number of IP addresses currently in use.

##### **Steps to Configure Monitoring:**

1. **Create a Monitoring Workspace**:
   - In the **Google Cloud Console**, go to **Monitoring** and create or open a **Monitoring Workspace**.

2. **Add the Proxy-Only Subnet Metric**:
   - Navigate to **Metrics Explorer**.
   - Select the **loadbalancing.googleapis.com/subnet/proxy_only/addresses** metric.
   - This will show you the number of IP addresses being utilized by your proxy-only subnet.

3. **Define an Alerting Policy**:
   - Set an **alerting policy** to trigger an alert when the number of used IP addresses reaches a certain threshold (e.g., 80% of the available addresses).
   - Example: For a /23 subnet (512 IP addresses), set the alert at around **410 addresses used** (80% utilization).
   - This gives you enough time to create a backup subnet and promote it before running out of IPs.

##### **Alerting Conditions**:
- **Condition**: `loadbalancing.googleapis.com/subnet/proxy_only/addresses` reaches **X%** of total IPs in the subnet.
- **Threshold Example**: 
  - For a /23 subnet with 512 addresses, alert if more than **410 IP addresses** are in use.
  - For a /22 subnet with 1024 addresses, alert if more than **819 IP addresses** are in use.

#### **2. Benefits of Monitoring and Alerting**:

- **Proactive Management**: By setting up alerts, you can avoid service interruptions due to running out of IP addresses.
- **Seamless Scaling**: Early alerts give your team time to provision a larger backup proxy-only subnet and promote it to active without affecting ongoing connections.
- **Cost Management**: Monitoring helps you understand usage patterns and ensures that you’re only allocating resources when needed.

---

### **Example Alerting Setup:**

- **Metric**: `loadbalancing.googleapis.com/subnet/proxy_only/addresses`
- **Alert Threshold**: 80% of IP address usage.
  - For **/23 subnet**: Alert when over **410 addresses** are in use.
  - For **/22 subnet**: Alert when over **819 addresses** are in use.
- **Notification Channel**: Configure email, SMS, or other notifications for your operations team to take action when the threshold is crossed.

By adding this monitoring and alerting mechanism to your **capacity management plan**, you ensure that proxy-only subnets for **ALB** are proactively managed, preventing any unexpected service disruption due to exhausted IP addresses.









### **Capacity Management Document for GCP Cloud Workstations with 4000 Workstations and ALB Setup**

---

#### **Introduction**

This document outlines the capacity management requirements for deploying **4000 Google Cloud Workstations**. We are using a custom domain setup, which involves deploying an **Application Load Balancer (ALB)**. Due to this, a **proxy-only subnet** is required for the ALB. The focus is on ensuring that we have sufficient **IP address allocation**, **CPU quotas**, **disk quotas**, and other critical resource limits in place for successful operation, while accounting for **system limits per region per project**.

---

### **1. Quota Requirements for 4000 Workstations**

We need to ensure that the following resources are adequately allocated for 4000 workstations, considering both compute and networking resources. Additionally, we will factor in the **system limits per region per project**.

#### **1.1 Compute Quotas**

The following quotas must be ensured for the VM instances that will host the workstations:
- **CPU Quota**: Each VM will require CPU resources based on its configuration (e.g., 4 vCPUs per workstation). For 4000 workstations, this can vary:
  - 4000 workstations × 4 vCPUs = **16,000 vCPUs**.
  
  **Note**: You must ensure that your regional CPU quota can accommodate these resources.

- **Persistent Disk Quota**: Allocate space for persistent disks based on VM configuration:
  - If each workstation is allocated 100GB persistent disk space:
    - 4000 workstations × 100 GB = **400 TB** of Persistent Disk quota.

- **External IP Quota**: If workstations are assigned external IP addresses, ensure sufficient **external IP quota** (although in this case, using ALB and private IPs might make this unnecessary).

---

#### **1.2 Regional System Limits for Cloud Workstations**

In addition to quotas, GCP Cloud Workstations impose certain **system limits per region per project** that need to be considered when deploying 4000 workstations:

| **Resource**                           | **Limit**                        |
|----------------------------------------|-----------------------------------|
| **Maximum Workstation Clusters**       | 5 clusters per region per project |
| **Maximum Workstation Configurations** | 200 configurations per project    |
| **Maximum Concurrent Workstations**    | 1000 workstations per project     |

---

**Consideration for 4000 Workstations:**
- **Workstation Clusters**: You will need to deploy multiple clusters since the limit is **5 clusters per region per project**. If you have 4000 workstations, each cluster should be able to handle 800 workstations (assuming even distribution).
  - **Required Clusters**: 4000 workstations ÷ 800 per cluster = **5 clusters**.
  
- **Workstation Configurations**: If each cluster has different configurations (up to **200 per project**), ensure that you manage this limit effectively based on the needs of your development environment.

- **Concurrent Workstations**: The system limit of **1000 concurrent workstations per project** means that you might need to plan across multiple regions if more than 1000 workstations need to run simultaneously.

---

#### **1.3 Network IP Address Quota**

Key networking considerations include IP address management within the **VPC** and the **proxy-only subnet** for the ALB. We need to ensure sufficient IP addresses are available to avoid subnet exhaustion.

#### **IP Addresses for Workstations**
- **4000 Workstations** = 4000 internal IP addresses.
- **Quick Start Pool** (optional): Add `n` IP addresses for pre-provisioned workstations. For example, if the pool size is set to 100, you need 100 additional IP addresses.
- **Cloud Workstation Controller**: Each configuration requires 1 IP address to establish the connection between the Cloud Workstations controller and the VPC.
- **Application Load Balancer (ALB)**: Requires IP addresses in the **proxy-only subnet**.

---

### **2. IP Address Allocation Planning**

For 4000 workstations, IP address allocation needs careful planning. We will calculate IP address needs based on **workstation IP requirements**, **Quick Start Pool**, **Cloud Workstation Controller**, and **ALB**.

---

### **3. Subnet Sizing and VPC Considerations**

#### **3.1 Subnet Sizing for Workstations**

We need to allocate a subnet large enough to accommodate all 4000 workstations, the quick start pool (if used), and other internal components like the Cloud Workstation controller.

Using CIDR subnetting, we can calculate the required subnet size:
- **IP addresses for 4000 workstations + 100 quick start pool + 1 controller IP**:
  - Total: **4101 IP addresses** required.
  
A **/19 subnet** will provide **8192 IP addresses**, which is sufficient for this setup.

#### **3.2 Subnet Sizing for ALB (Proxy-Only Subnet)**

For the **Application Load Balancer (ALB)**, a **proxy-only subnet** is required. The size of the subnet must account for the ALB’s load balancer components:
- ALB components typically use around **4-6 IP addresses** (depending on the setup).
  
A **/28 subnet** will provide **16 IP addresses**, sufficient for the ALB components.

---

### **4. Resource Quota Requirements for GCP**

To ensure smooth operation of 4000 Cloud Workstations, the following GCP quotas need to be requested and validated:

| **Resource**              | **Quota Required**             |
|---------------------------|--------------------------------|
| **vCPUs**                 | 16,000                         |
| **Persistent Disk (SSD)**  | 400 TB                         |
| **Internal IP Addresses**  | 4101 (for /19 subnet)          |
| **External IP Addresses**  | Optional, depending on setup   |
| **ALB IP Addresses**       | 16 IPs for proxy-only subnet   |

---

### **5. Subnet Configuration Summary**

- **Workstation Subnet**: Configure a **/19 subnet** within your VPC to provide 8192 IP addresses.
  - Total IPs: 8192
  - 4000 for workstations.
  - 100 for Quick Start Pool (optional).
  - 1 for Workstation controller.
  - Remaining IPs for future expansion or other resources.

- **ALB Proxy-Only Subnet**: Configure a **/28 subnet** for the ALB with 16 IP addresses.
  - Total IPs: 16
  - 4-6 IP addresses for ALB components.

---

### **6. Quota Request**

Ensure that the following quotas are requested and approved in your GCP project:

| **Resource**              | **Quota Required**             |
|---------------------------|--------------------------------|
| **vCPUs**                 | 16,000                         |
| **Persistent Disk (SSD)**  | 400 TB                         |
| **Internal IP Addresses**  | 4101 (for /19 subnet)          |
| **External IP Addresses**  | Optional, depending on setup   |
| **ALB IP Addresses**       | 16 IPs for proxy-only subnet   |

---

### **7. Summary and Conclusion**

- A **/19 subnet** for Cloud Workstations is sufficient to accommodate 4000 workstations, a Quick Start Pool, and the Workstation controller.
- A **/28 proxy-only subnet** is required for the Application Load Balancer (ALB) components.
- Ensure sufficient **CPU and Persistent Disk quotas** for the workstation fleet.
- Request the appropriate **internal IP address quota** in your GCP project.
- Consider the **system limits per region per project** when planning for workstation clusters, configurations, and concurrent workstations. If you need to run more than 1000 workstations concurrently, plan across multiple regions.

By following these guidelines, your team will have enough capacity to run 4000 workstations efficiently while ensuring proper resource management for ALB, network configurations, and quota allocations across regions.
